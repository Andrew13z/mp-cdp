-- IMPORT STUDENTS

COPY STUDENTS(FIRSTNAME, SURNAME, DATE_OF_BIRTH, PHONE_NUMBER, PRIMARY_SKILL)
FROM '/data/students.csv'
DELIMITER ','
CSV HEADER;

SELECT COUNT(1) FROM STUDENTS;


-- IMPORT SUBJECTS

COPY SUBJECTS(TITLE, TUTOR_NAME)
FROM '/data/subjects.csv'
DELIMITER ','
CSV HEADER;

select count(1) from SUBJECTS;

-- CREATE TEMPORARY TABLE FOR EXAM RESULTS WITHOUT CONSTRAINTS AND IMPORT DATA THERE
-- IMPORTING SHOULD BE DONE FOR 10 FILES AS MAMXIMUM NUMBER OF ROWS THAT COULD BE GENERATED BY THE SITE WAS 100,000 
-- THIS WAS DONE BECAUSE THE GENERATED DATA VIOLATED UNIQUE (STUDENT_ID, SUBJECT_ID) CONSTRAINT

CREATE TABLE PUBLIC.EXAM_RESULTS_TEMP (
	STUDENT_ID BIGINT,
	SUBJECT_ID BIGINT,
	MARK SMALLINT
);

COPY EXAM_RESULTS_TEMP(STUDENT_ID, SUBJECT_ID, MARK)
FROM '/data/marks-1-1.csv'
DELIMITER ','
CSV HEADER;

SELECT COUNT(1) FROM EXAM_RESULTS_TEMP;

-- COPY VALID DATA FROM TEMPORARY TABLE TO EXAM_RESULTS

INSERT INTO EXAM_RESULTS
(SELECT STUDENT_ID, SUBJECT_ID, MAX(MARK) AS MARK
FROM EXAM_RESULTS_TEMP
GROUP BY STUDENT_ID, SUBJECT_ID);

SELECT COUNT(1) FROM EXAM_RESULTS;

--DROP TEMPORARY TABLE
DROP TABLE EXAM_RESULTS_TEMP;






